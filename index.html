<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatCounter æ•¸æ“šå¯è¦–åŒ–å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .chart-container { position: relative; height: 300px; }
        .detail-chart-container { position: relative; height: 250px; }
        .loading { display: flex; justify-content: center; align-items: center; height: 200px; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .data-item { cursor: pointer; transition: background-color 0.2s; }
        .data-item:hover { background-color: rgba(6, 182, 212, 0.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold mb-2 text-gray-800">StatCounter æ•¸æ“šå¯è¦–åŒ–å„€è¡¨æ¿</h1>
            <p class="text-gray-600">å…¨çƒèˆ‡å°ç£å¸‚å ´æ•¸æ“šåˆ†æ</p>
            <button onclick="refreshData()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm shadow-md">
                ğŸ”„ åˆ·æ–°æ•¸æ“š
            </button>
        </header>

        <!-- ä¸Šæ–¹ï¼šå…¨çƒå’Œå°ç£çš„ä¸»è¦æ•¸æ“šé¡¯ç¤º -->
        <section class="mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">ä¸»è¦æ•¸æ“š - å…¨çƒ & å°ç£ï¼ˆæ‰€æœ‰å¹³å° / æ‰‹æ©Ÿ / é›»è…¦ / å¹³æ¿ï¼‰å¸‚ä½”ç‡å‰ä¸‰</h2>
            </div>
            <div class="grid grid-cols-1 gap-4 mb-6">
                <!-- å…¨çƒæ•¸æ“šå¡ç‰‡ -->
                <div class="bg-gradient-to-br from-blue-100 via-cyan-50 to-blue-100 rounded-lg p-4 metric-card border-2 border-blue-400 shadow-xl shadow-blue-300/30">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">ğŸŒ å…¨çƒ</h3>
                    <div id="globalMetrics" class="space-y-4">
                        <div class="loading">
                            <div class="text-gray-600">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
                
                <!-- å°ç£æ•¸æ“šå¡ç‰‡ -->
                <div class="bg-gradient-to-br from-orange-100 via-amber-50 to-orange-100 rounded-lg p-4 metric-card border-2 border-orange-400 shadow-xl shadow-orange-300/30">
                    <div class="flex items-center mb-4 gap-3">
                        <h3 id="twCountryTitle" class="text-xl font-bold text-orange-700">ğŸ‡¹ğŸ‡¼ å°ç£</h3>
                        <div class="flex items-center gap-2">
                            <label for="twCountrySelect" class="text-sm font-medium text-orange-700 whitespace-nowrap">é¸æ“‡åœ‹å®¶ï¼š</label>
                            <select id="twCountrySelect" class="bg-white/90 border border-orange-400 rounded-lg px-3 py-1 text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400 min-w-[200px]">
                                <option value="tw">å°ç£</option>
                                <option value="global">å…¨çƒ</option>
                                <optgroup label="åœ°å€">
                                    <option value="asia">äºæ´²</option>
                                    <option value="europe">æ­æ´²</option>
                                    <option value="africa">éæ´²</option>
                                    <option value="north-america">åŒ—ç¾æ´²</option>
                                </optgroup>
                                <optgroup label="æ±äº">
                                    <option value="cn">ä¸­åœ‹</option>
                                    <option value="hk">é¦™æ¸¯</option>
                                    <option value="mo">æ¾³é–€</option>
                                    <option value="jp">æ—¥æœ¬</option>
                                    <option value="kr">éŸ“åœ‹</option>
                                </optgroup>
                                <optgroup label="æ±å—äº">
                                    <option value="ph">è²å¾‹è³“</option>
                                    <option value="th">æ³°åœ‹</option>
                                    <option value="vn">è¶Šå—</option>
                                    <option value="id">å°å°¼</option>
                                    <option value="mm">ç·¬ç”¸</option>
                                    <option value="my">é¦¬ä¾†è¥¿äº</option>
                                </optgroup>
                                <optgroup label="å—äº">
                                    <option value="in">å°åº¦</option>
                                    <option value="bd">å­ŸåŠ æ‹‰åœ‹</option>
                                    <option value="pk">å·´åŸºæ–¯å¦</option>
                                </optgroup>
                                <optgroup label="è‹±èªç³»åœ‹å®¶">
                                    <option value="us">ç¾åœ‹</option>
                                    <option value="gb">è‹±åœ‹</option>
                                    <option value="ca">åŠ æ‹¿å¤§</option>
                                    <option value="au">æ¾³æ´²</option>
                                    <option value="nz">ç´è¥¿è˜­</option>
                                    <option value="ie">æ„›çˆ¾è˜­</option>
                                    <option value="za">å—é</option>
                                </optgroup>
                                <optgroup label="æ­æ´²å…¶ä»–">
                                    <option value="es">è¥¿ç­ç‰™</option>
                                    <option value="pt">è‘¡è„ç‰™</option>
                                    <option value="it">ç¾©å¤§åˆ©</option>
                                    <option value="se">ç‘å…¸</option>
                                    <option value="de">å¾·åœ‹</option>
                                    <option value="dk">ä¸¹éº¥</option>
                                    <option value="ro">ç¾…é¦¬å°¼äº</option>
                                    <option value="nl">è·è˜­</option>
                                    <option value="gr">å¸Œè‡˜</option>
                                    <option value="fr">æ³•åœ‹</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–">
                                    <option value="tr">åœŸè€³å…¶</option>
                                    <option value="ru">ä¿„ç¾…æ–¯</option>
                                    <option value="br">å·´è¥¿</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div id="twMetrics" class="space-y-4">
                        <div class="loading">
                            <div class="text-gray-600">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- åˆ†éš”ç·š -->
        <div class="border-t border-gray-300 my-8"></div>

        <!-- ä¸‹æ–¹ï¼šå…¶ä»–åœ‹å®¶ç¯©é¸å’Œè©³ç´°æ•¸æ“š -->
        <section>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">å…¶ä»–ç´°é …æ•¸æ“šæŸ¥è©¢</h2>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="bg-white rounded-lg p-6 mb-6 shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="countrySelect" class="block text-sm font-medium mb-2 text-gray-700">é¸æ“‡åœ‹å®¶/åœ°å€ï¼š</label>
                        <select id="countrySelect" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- è«‹é¸æ“‡ --</option>
                            <option value="global">å…¨çƒ</option>
                            <option value="tw">å°ç£</option>
                            <optgroup label="åœ°å€">
                                <option value="asia">äºæ´²</option>
                                <option value="europe">æ­æ´²</option>
                                <option value="africa">éæ´²</option>
                                <option value="north-america">åŒ—ç¾æ´²</option>
                            </optgroup>
                            <optgroup label="æ±äº">
                                <option value="cn">ä¸­åœ‹</option>
                                <option value="hk">é¦™æ¸¯</option>
                                <option value="mo">æ¾³é–€</option>
                                <option value="jp">æ—¥æœ¬</option>
                                <option value="kr">éŸ“åœ‹</option>
                            </optgroup>
                            <optgroup label="æ±å—äº">
                                <option value="ph">è²å¾‹è³“</option>
                                <option value="th">æ³°åœ‹</option>
                                <option value="vn">è¶Šå—</option>
                                <option value="id">å°å°¼</option>
                                <option value="mm">ç·¬ç”¸</option>
                                <option value="my">é¦¬ä¾†è¥¿äº</option>
                            </optgroup>
                            <optgroup label="å—äº">
                                <option value="in">å°åº¦</option>
                                <option value="bd">å­ŸåŠ æ‹‰åœ‹</option>
                                <option value="pk">å·´åŸºæ–¯å¦</option>
                            </optgroup>
                            <optgroup label="è‹±èªç³»åœ‹å®¶">
                                <option value="us">ç¾åœ‹</option>
                                <option value="gb">è‹±åœ‹</option>
                                <option value="ca">åŠ æ‹¿å¤§</option>
                                <option value="au">æ¾³æ´²</option>
                                <option value="nz">ç´è¥¿è˜­</option>
                                <option value="ie">æ„›çˆ¾è˜­</option>
                                <option value="za">å—é</option>
                            </optgroup>
                            <optgroup label="æ­æ´²å…¶ä»–">
                                <option value="es">è¥¿ç­ç‰™</option>
                                <option value="pt">è‘¡è„ç‰™</option>
                                <option value="it">ç¾©å¤§åˆ©</option>
                                <option value="se">ç‘å…¸</option>
                                <option value="de">å¾·åœ‹</option>
                                <option value="dk">ä¸¹éº¥</option>
                                <option value="ro">ç¾…é¦¬å°¼äº</option>
                                <option value="nl">è·è˜­</option>
                                <option value="gr">å¸Œè‡˜</option>
                                <option value="fr">æ³•åœ‹</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–">
                                <option value="tr">åœŸè€³å…¶</option>
                                <option value="ru">ä¿„ç¾…æ–¯</option>
                                <option value="br">å·´è¥¿</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div>
                        <label for="dataTypeSelect" class="block text-sm font-medium mb-2 text-gray-700">é¸æ“‡æ•¸æ“šé¡å‹ï¼š</label>
                        <select id="dataTypeSelect" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="platform">æ‰‹æ©Ÿ/é›»è…¦/å¹³æ¿å¸‚å ´ä½”æœ‰ç‡</option>
                            <option value="os_all">ä½œæ¥­ç³»çµ±</option>
                            <option value="browser_all">ç€è¦½å™¨å¸‚ä½”ç‡</option>
                            <option value="resolution_all">è¢å¹•è§£æåº¦</option>
                            <option value="vendor_mobile">æ‰‹æ©Ÿå“ç‰Œ</option>
                            <option value="search_engine_all">æœç´¢å¼•æ“å¸‚ä½”ç‡</option>
                            <option value="social_media_all">ç¤¾äº¤åª’é«”å¸‚ä½”ç‡</option>
                        </select>
                    </div>

                    <div>
                        <label for="platformSelect" class="block text-sm font-medium mb-2 text-gray-700">é¸æ“‡å¹³å°ï¼š</label>
                        <select id="platformSelect" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">æ‰€æœ‰å¹³å°</option>
                            <option value="mobile">æ‰‹æ©Ÿ</option>
                            <option value="desktop">é›»è…¦</option>
                            <option value="tablet">å¹³æ¿</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°åœ–è¡¨ -->
            <div id="detailSection" class="hidden">
                <div class="bg-white rounded-lg p-6 mb-6 shadow-md border border-gray-200">
                    <h3 id="chartTitle" class="text-2xl font-bold mb-4 text-gray-800">æ•¸æ“šåœ–è¡¨</h3>
                    <div id="loading" class="loading">
                        <div class="text-gray-600">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div id="chartWrapper" class="hidden">
                        <div class="detail-chart-container">
                            <canvas id="dataChart"></canvas>
                        </div>
                        <!-- æ•¸æ“šä¾†æºæœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
                    </div>
                    <div id="noData" class="hidden text-center text-gray-600 py-8">
                        æš«ç„¡æ•¸æ“š
                    </div>
                </div>

                <!-- æ•¸æ“šè¡¨æ ¼ -->
                <div class="bg-white rounded-lg p-6 shadow-md border border-gray-200">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">æ•¸æ“šè¡¨æ ¼</h3>
                    <div id="dataTable" class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-300 bg-gray-50">
                                    <th class="py-2 px-4 text-gray-700 font-semibold">é …ç›®</th>
                                    <th class="py-2 px-4 text-gray-700 font-semibold">å¸‚å ´ä½”æœ‰ç‡</th>
                                    <th class="py-2 px-4 text-gray-700 font-semibold">å¹³å°</th>
                                    <th class="py-2 px-4 text-gray-700 font-semibold">æ•¸æ“šä¾†æº</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let currentChart = null;
        let allCharts = []; // ç®¡ç†æ‰€æœ‰åœ–è¡¨å¯¦ä¾‹
        let dataCache = {};
        let globalData = null;
        let twData = null;

        // æ•¸æ“šé¡å‹åç¨±æ˜ å°„
        const typeNames = {
            'platform': 'è£ç½®é¡å‹å¸‚ä½”ç‡',
            'os_all': 'ä½œæ¥­ç³»çµ±',
            'browser_all': 'ç€è¦½å™¨å¸‚ä½”ç‡',
            'resolution_all': 'è¢å¹•è§£æåº¦',
            'vendor_mobile': 'æ‰‹æ©Ÿå“ç‰Œ',
            'search_engine_all': 'æœç´¢å¼•æ“å¸‚ä½”ç‡',
            'social_media_all': 'ç¤¾äº¤åª’é«”å¸‚ä½”ç‡'
        };

        // åœ‹å®¶åç¨±å’Œemojiæ˜ å°„
        const countryEmojiMap = {
            'global': { emoji: 'ğŸŒ', name: 'å…¨çƒ' },
            'tw': { emoji: 'ğŸ‡¹ğŸ‡¼', name: 'å°ç£' },
            'cn': { emoji: 'ğŸ‡¨ğŸ‡³', name: 'ä¸­åœ‹' },
            'hk': { emoji: 'ğŸ‡­ğŸ‡°', name: 'é¦™æ¸¯' },
            'mo': { emoji: 'ğŸ‡²ğŸ‡´', name: 'æ¾³é–€' },
            'kr': { emoji: 'ğŸ‡°ğŸ‡·', name: 'éŸ“åœ‹' },
            'ph': { emoji: 'ğŸ‡µğŸ‡­', name: 'è²å¾‹è³“' },
            'th': { emoji: 'ğŸ‡¹ğŸ‡­', name: 'æ³°åœ‹' },
            'vn': { emoji: 'ğŸ‡»ğŸ‡³', name: 'è¶Šå—' },
            'id': { emoji: 'ğŸ‡®ğŸ‡©', name: 'å°å°¼' },
            'mm': { emoji: 'ğŸ‡²ğŸ‡²', name: 'ç·¬ç”¸' },
            'jp': { emoji: 'ğŸ‡¯ğŸ‡µ', name: 'æ—¥æœ¬' },
            'my': { emoji: 'ğŸ‡²ğŸ‡¾', name: 'é¦¬ä¾†è¥¿äº' },
            'in': { emoji: 'ğŸ‡®ğŸ‡³', name: 'å°åº¦' },
            'bd': { emoji: 'ğŸ‡§ğŸ‡©', name: 'å­ŸåŠ æ‹‰åœ‹' },
            'us': { emoji: 'ğŸ‡ºğŸ‡¸', name: 'ç¾åœ‹' },
            'gb': { emoji: 'ğŸ‡¬ğŸ‡§', name: 'è‹±åœ‹' },
            'ca': { emoji: 'ğŸ‡¨ğŸ‡¦', name: 'åŠ æ‹¿å¤§' },
            'au': { emoji: 'ğŸ‡¦ğŸ‡º', name: 'æ¾³æ´²' },
            'nz': { emoji: 'ğŸ‡³ğŸ‡¿', name: 'ç´è¥¿è˜­' },
            'ie': { emoji: 'ğŸ‡®ğŸ‡ª', name: 'æ„›çˆ¾è˜­' },
            'za': { emoji: 'ğŸ‡¿ğŸ‡¦', name: 'å—é' },
            'es': { emoji: 'ğŸ‡ªğŸ‡¸', name: 'è¥¿ç­ç‰™' },
            'pt': { emoji: 'ğŸ‡µğŸ‡¹', name: 'è‘¡è„ç‰™' },
            'it': { emoji: 'ğŸ‡®ğŸ‡¹', name: 'ç¾©å¤§åˆ©' },
            'se': { emoji: 'ğŸ‡¸ğŸ‡ª', name: 'ç‘å…¸' },
            'de': { emoji: 'ğŸ‡©ğŸ‡ª', name: 'å¾·åœ‹' },
            'dk': { emoji: 'ğŸ‡©ğŸ‡°', name: 'ä¸¹éº¥' },
            'ro': { emoji: 'ğŸ‡·ğŸ‡´', name: 'ç¾…é¦¬å°¼äº' },
            'nl': { emoji: 'ğŸ‡³ğŸ‡±', name: 'è·è˜­' },
            'gr': { emoji: 'ğŸ‡¬ğŸ‡·', name: 'å¸Œè‡˜' },
            'fr': { emoji: 'ğŸ‡«ğŸ‡·', name: 'æ³•åœ‹' },
            'tr': { emoji: 'ğŸ‡¹ğŸ‡·', name: 'åœŸè€³å…¶' },
            'ru': { emoji: 'ğŸ‡·ğŸ‡º', name: 'ä¿„ç¾…æ–¯' },
            'pk': { emoji: 'ğŸ‡µğŸ‡°', name: 'å·´åŸºæ–¯å¦' },
            'br': { emoji: 'ğŸ‡§ğŸ‡·', name: 'å·´è¥¿' },
            'asia': { emoji: 'ğŸŒ', name: 'äºæ´²' },
            'europe': { emoji: 'ğŸ‡ªğŸ‡º', name: 'æ­æ´²' },
            'africa': { emoji: 'ğŸŒ', name: 'éæ´²' },
            'north-america': { emoji: 'ğŸŒ', name: 'åŒ—ç¾æ´²' }
        };

        // åœ‹å®¶åç¨±åˆ°URL slugçš„æ˜ å°„
        const countrySlugMap = {
            'global': 'worldwide',
            'tw': 'taiwan',
            'cn': 'china',
            'hk': 'hong-kong',
            'mo': 'macao',
            'kr': 'south-korea',
            'ph': 'philippines',
            'th': 'thailand',
            'vn': 'viet-nam',
            'id': 'indonesia',
            'mm': 'myanmar',
            'jp': 'japan',
            'my': 'malaysia',
            'in': 'india',
            'bd': 'bangladesh',
            'us': 'united-states-of-america',
            'gb': 'united-kingdom',
            'ca': 'canada',
            'au': 'australia',
            'nz': 'new-zealand',
            'ie': 'ireland',
            'za': 'south-africa',
            'es': 'spain',
            'pt': 'portugal',
            'it': 'italy',
            'se': 'sweden',
            'de': 'germany',
            'dk': 'denmark',
            'ro': 'romania',
            'nl': 'netherlands',
            'gr': 'greece',
            'fr': 'france',
            'tr': 'turkey',
            'ru': 'russian-federation',
            'pk': 'pakistan',
            'br': 'brazil',
            'asia': 'asia',
            'europe': 'europe',
            'africa': 'africa',
            'north-america': 'north-america'
        };

        // ä¿®æ­£ vendor_mobile çš„ URL
        function fixVendorUrl(url, countryCode, platform) {
            if (!url || !url.includes('vendor-market-share')) {
                return url;
            }
            
            const countrySlug = countrySlugMap[countryCode] || countryCode;
            
            // æ ¹æ“šå¹³å°æ§‹å»ºæ­£ç¢ºçš„ URL
            if (platform === 'mobile') {
                if (countryCode === 'global') {
                    return 'https://gs.statcounter.com/vendor-market-share/mobile';
                }
                return `https://gs.statcounter.com/vendor-market-share/mobile/${countrySlug}`;
            } else if (platform === 'tablet') {
                if (countryCode === 'global') {
                    return 'https://gs.statcounter.com/vendor-market-share/tablet';
                }
                return `https://gs.statcounter.com/vendor-market-share/tablet/${countrySlug}`;
            } else if (platform === 'desktop') {
                if (countryCode === 'global') {
                    return 'https://gs.statcounter.com/vendor-market-share/desktop';
                }
                return `https://gs.statcounter.com/vendor-market-share/desktop/${countrySlug}`;
            } else {
                // all platform
                if (countryCode === 'global') {
                    return 'https://gs.statcounter.com/vendor-market-share/all';
                }
                return `https://gs.statcounter.com/vendor-market-share/all/${countrySlug}`;
            }
        }

        // å¹³å°åç¨±æ˜ å°„
        const platformNames = {
            'all': 'æ‰€æœ‰å¹³å°',
            'mobile': 'æ‰‹æ©Ÿ',
            'desktop': 'é›»è…¦',
            'tablet': 'å¹³æ¿'
        };

        // è¼‰å…¥æ‰€æœ‰æ•¸æ“šï¼ˆå…¨çƒ & å°ç£ï¼‰
        async function loadAllData() {
            console.log('é–‹å§‹è¼‰å…¥æ•¸æ“š...');
            
            try {
                // è¼‰å…¥å…¨çƒæ•¸æ“š
                const globalResponse = await fetch('statcounter_data/global_data.json');
                if (globalResponse.ok) {
                    globalData = await globalResponse.json();
                    dataCache['global'] = globalData;
                    displayMainMetrics('global', globalData, 'globalMetrics');
                }
                
                // è¼‰å…¥å°ç£æ•¸æ“šï¼ˆæˆ–é¸æ“‡çš„åœ‹å®¶ï¼‰
                await loadTwCountryData();
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥å°ç£ï¼ˆæˆ–é¸æ“‡çš„åœ‹å®¶ï¼‰æ•¸æ“š
        async function loadTwCountryData() {
            const selectedCountry = document.getElementById('twCountrySelect').value || 'tw';
            
            // æ›´æ–°æ¨™é¡Œ
            const countryInfo = countryEmojiMap[selectedCountry] || { emoji: 'ğŸŒ', name: selectedCountry };
            const titleElement = document.getElementById('twCountryTitle');
            if (titleElement) {
                titleElement.textContent = `${countryInfo.emoji} ${countryInfo.name}`;
            }
            
            try {
                if (dataCache[selectedCountry]) {
                    displayMainMetrics(selectedCountry, dataCache[selectedCountry], 'twMetrics');
                } else {
                    const response = await fetch(`statcounter_data/${selectedCountry}_data.json`);
                    if (response.ok) {
                        const countryData = await response.json();
                        dataCache[selectedCountry] = countryData;
                        if (selectedCountry === 'tw') {
                            twData = countryData;
                        }
                        displayMainMetrics(selectedCountry, countryData, 'twMetrics');
                    } else {
                        document.getElementById('twMetrics').innerHTML = '<div class="text-gray-600">æš«ç„¡æ•¸æ“š</div>';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥å°ç£/é¸æ“‡åœ‹å®¶æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('twMetrics').innerHTML = '<div class="text-gray-600">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // åˆ·æ–°æ•¸æ“š
        function refreshData() {
            dataCache = {};
            loadAllData();
            if (document.getElementById('countrySelect').value) {
                loadCountryData();
            }
        }

        // é¡¯ç¤ºä¸»è¦æŒ‡æ¨™ï¼ˆå…¨çƒ / å°ç£ï¼š4 å€‹å¹³å°å‚ç›´æ’åˆ—ï¼Œç´°é …æ°´å¹³æ’åˆ—ï¼Œé¡¯ç¤ºå‰ä¸‰ï¼‰
        function displayMainMetrics(countryCode, countryData, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
                if (!countryData || !countryData.data) {
                container.innerHTML = '<div class="text-gray-600">æš«ç„¡æ•¸æ“š</div>';
                return;
            }

            const platforms = ['all', 'mobile', 'desktop', 'tablet']; // ä¸Šåˆ°ä¸‹ï¼šæ‰€æœ‰å¹³å° / æ‰‹æ©Ÿ / é›»è…¦ / å¹³æ¿
            const platformLabels = {
                all: 'æ‰€æœ‰å¹³å°',
                mobile: 'æ‰‹æ©Ÿ',
                desktop: 'é›»è…¦',
                tablet: 'å¹³æ¿'
            };

            // æ ¹æ“šå®¹å™¨IDæ±ºå®šé¡è‰²ä¸»é¡Œ - æ˜äº®çš„é…è‰²æ–¹æ¡ˆ
            const isGlobal = containerId === 'globalMetrics';
            // å…¨çƒï¼šæ˜äº®çš„è—è‰²/é’è‰²ç³»ï¼ˆå†·è‰²ï¼‰
            // å°ç£/é¸æ“‡åœ‹å®¶ï¼šæ˜äº®çš„æ©™è‰²/ç¥ç€è‰²ç³»ï¼ˆæš–è‰²ï¼‰
            const borderColor = isGlobal ? 'border-blue-400' : 'border-orange-400';
            const textColor = isGlobal ? 'text-blue-700' : 'text-orange-700';
            const valueColor = isGlobal ? 'text-blue-600' : 'text-orange-600';
            const cardBgColor = isGlobal ? 'bg-blue-50/80' : 'bg-orange-50/80';

            // 4 å€‹å¹³å°å‚ç›´æ’åˆ—ï¼Œæ¯ä¸€åˆ—æ˜¯å¹³å°ï¼Œç´°é …ï¼ˆæ•¸æ“šé¡å‹ï¼‰æ°´å¹³æ’åˆ—ä¸”ä¸è¶…å‡ºå¡ç‰‡å¯¬åº¦
            platforms.forEach(platformKey => {
                // æ”¶é›†é€™å€‹å¹³å°æ‰€æœ‰æ•¸æ“šé¡å‹çš„å‰ä¸‰æ•¸æ“š
                const metrics = [];

                Object.keys(countryData.data).forEach(dataType => {
                    const dataInfo = countryData.data[dataType];
                    if (!dataInfo) return;

                    let platformData = null;
                    if (platformKey === 'all') {
                        platformData = dataInfo.all || dataInfo.mobile || dataInfo.desktop || dataInfo.tablet;
                    } else {
                        platformData = dataInfo[platformKey];
                    }

                    if (!platformData || !platformData.data || platformData.data.length === 0) return;

                    // ä¿®æ­£ vendor_mobile çš„ URL
                    let url = platformData.url || dataInfo.url;
                    if (dataType === 'vendor_mobile') {
                        url = fixVendorUrl(url, countryCode, platformKey);
                    }

                    // ç‰¹æ®Šè™•ç† platform é¡å‹ï¼šé¡¯ç¤ºè£ç½®é¡å‹å¸‚ä½”ç‡æ ¼å¼
                    if (dataType === 'platform') {
                        // å¾ all å¹³å°æ•¸æ“šä¸­æå– Mobile, Desktop, Tablet çš„å‰ä¸‰
                        const allPlatformData = dataInfo.all || dataInfo.mobile || dataInfo.desktop || dataInfo.tablet;
                        if (allPlatformData && allPlatformData.data) {
                            const top3 = allPlatformData.data.slice(0, 3);
                            if (top3.length > 0) {
                                metrics.push({
                                    type: dataType,
                                    typeName: typeNames[dataType] || dataType,
                                    top3: top3,
                                    url: fixVendorUrl(allPlatformData.url, countryCode, 'all')
                                });
                            }
                        }
                    } else {
                        // å…¶ä»–é¡å‹ï¼šé¡¯ç¤ºå‰ä¸‰
                        const top3 = platformData.data.slice(0, 3);
                        if (top3.length > 0) {
                            metrics.push({
                                type: dataType,
                                typeName: typeNames[dataType] || dataType,
                                top3: top3,
                                url: url
                            });
                        }
                    }
                });

                if (metrics.length === 0) return;

                // å¹³å°ä¸€åˆ—
                const row = document.createElement('div');
                row.className = 'mb-2';

                // å¹³å°æ¨™é¡Œ
                const title = document.createElement('div');
                title.className = `text-sm font-bold mb-1 ${textColor}`;
                title.textContent = platformLabels[platformKey] || platformKey;
                row.appendChild(title);

                // ç´°é …æ°´å¹³æ’åˆ—
                const list = document.createElement('div');
                list.className = 'flex flex-wrap gap-2';

                metrics.forEach(m => {
                    const itemCard = document.createElement('div');
                    itemCard.className = `${cardBgColor} rounded-lg px-3 py-2 text-[12px] flex flex-col items-center justify-center gap-1 border-2 ${borderColor} shadow-md flex-1 min-w-[120px] max-w-[170px] text-center`;

                    if (m.url) {
                        itemCard.onclick = () => window.open(m.url, '_blank');
                        itemCard.className += ' cursor-pointer';
                        itemCard.title = 'é»æ“ŠæŸ¥çœ‹æ•¸æ“šä¾†æº';
                    }

                    const typeEl = document.createElement('div');
                    typeEl.className = `${textColor} font-semibold`;
                    typeEl.textContent = `${m.typeName}ï¼š`;

                    // ç‰¹æ®Šè™•ç† platform é¡å‹
                    if (m.type === 'platform') {
                        const contentEl = document.createElement('div');
                        contentEl.className = 'text-gray-800 font-medium text-[11px]';
                        const parts = [];
                        m.top3.forEach((item, idx) => {
                            const platformName = item.name === 'Mobile' ? 'Mobile' : item.name === 'Desktop' ? 'Desktop' : item.name === 'Tablet' ? 'Tablet' : item.name;
                            const valueSpan = `<span class="${valueColor} font-bold">${item.value.toFixed(2)}%</span>`;
                            parts.push(`${platformName}:${valueSpan}`);
                        });
                        contentEl.innerHTML = parts.join(' ');
                        itemCard.appendChild(typeEl);
                        itemCard.appendChild(contentEl);
                    } else {
                        // å…¶ä»–é¡å‹ï¼šé¡¯ç¤ºå‰ä¸‰ï¼Œæ¯è¡Œä¸€å€‹
                        const contentEl = document.createElement('div');
                        contentEl.className = 'text-gray-800 font-medium text-[11px] space-y-0.5';
                        m.top3.forEach((item, idx) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.innerHTML = `${item.name}:<span class="${valueColor} font-bold">${item.value.toFixed(1)}%</span>`;
                            contentEl.appendChild(itemDiv);
                        });
                        itemCard.appendChild(typeEl);
                        itemCard.appendChild(contentEl);
                    }

                    list.appendChild(itemCard);
                });

                row.appendChild(list);
                container.appendChild(row);
            });
        }

        // æ ¹æ“šå¯¦éš›å¯ç”¨æ•¸æ“šï¼Œå‹•æ…‹æ›´æ–°å¹³å°é¸é …ï¼ˆé¿å…é¸åˆ°æ²’æœ‰æ•¸æ“šçš„å¹³å°ï¼‰
        function updatePlatformOptions(countryData, dataType) {
            const platformSelect = document.getElementById('platformSelect');
            if (!platformSelect) return;

            const allPlatforms = [
                { value: 'all', label: platformNames['all'] || 'æ‰€æœ‰å¹³å°' },
                { value: 'mobile', label: platformNames['mobile'] || 'æ‰‹æ©Ÿ' },
                { value: 'desktop', label: platformNames['desktop'] || 'é›»è…¦' },
                { value: 'tablet', label: platformNames['tablet'] || 'å¹³æ¿' },
            ];

            const available = new Set();

            if (!countryData || !countryData.data) {
                // æ²’æœ‰æ•¸æ“šæ™‚ï¼Œè‡³å°‘ä¿ç•™ã€Œæ‰€æœ‰å¹³å°ã€
                available.add('all');
            } else if (dataType === 'all') {
                // ã€Œå…¨éƒ¨ã€æ™‚ï¼Œæ ¹æ“šæ‰€æœ‰æ•¸æ“šé¡å‹ç¶œåˆåˆ¤æ–·æœ‰å“ªäº›å¹³å°æœ‰æ•¸æ“š
                Object.keys(countryData.data).forEach(typeKey => {
                    const info = countryData.data[typeKey];
                    if (!info) return;
                    if (info.all && info.all.data && info.all.data.length > 0) available.add('all');
                    if (info.mobile && info.mobile.data && info.mobile.data.length > 0) available.add('mobile');
                    if (info.desktop && info.desktop.data && info.desktop.data.length > 0) available.add('desktop');
                    if (info.tablet && info.tablet.data && info.tablet.data.length > 0) available.add('tablet');
                });
            } else {
                // ç‰¹å®šæ•¸æ“šé¡å‹æ™‚ï¼Œåªçœ‹è©²é¡å‹
                const info = countryData.data[dataType];
                if (info) {
                    if (info.all && info.all.data && info.all.data.length > 0) available.add('all');
                    if (info.mobile && info.mobile.data && info.mobile.data.length > 0) available.add('mobile');
                    if (info.desktop && info.desktop.data && info.desktop.data.length > 0) available.add('desktop');
                    if (info.tablet && info.tablet.data && info.tablet.data.length > 0) available.add('tablet');
                }
            }

            // å¦‚æœä»€éº¼éƒ½æ²’æœ‰åµæ¸¬åˆ°ï¼Œä¿åº•çµ¦ä¸€å€‹ all
            if (available.size === 0) {
                available.add('all');
            }

            const previousValue = platformSelect.value;
            platformSelect.innerHTML = '';

            let firstValue = null;
            allPlatforms.forEach(p => {
                if (available.has(p.value)) {
                    const opt = document.createElement('option');
                    opt.value = p.value;
                    opt.textContent = p.label;
                    platformSelect.appendChild(opt);
                    if (!firstValue) firstValue = p.value;
                }
            });

            // å„ªå…ˆä¿ç•™åŸæœ¬é¸æ“‡ï¼Œå¦‚æœå·²ç¶“ä¸åœ¨å¯ç”¨æ¸…å–®ï¼Œå°±æ”¹æˆç¬¬ä¸€å€‹
            if (available.has(previousValue)) {
                platformSelect.value = previousValue;
            } else if (firstValue) {
                platformSelect.value = firstValue;
            }
        }

        // è¼‰å…¥å–®å€‹åœ‹å®¶æ•¸æ“š
        let isLoading = false; // é˜²æ­¢é‡è¤‡åŠ è¼‰
        
        async function loadCountryData() {
            // é˜²æ­¢é‡è¤‡èª¿ç”¨
            if (isLoading) {
                return;
            }
            
            const country = document.getElementById('countrySelect').value;
            const dataType = document.getElementById('dataTypeSelect').value;
            const platform = document.getElementById('platformSelect').value;
            
            if (!country) {
                document.getElementById('detailSection').classList.add('hidden');
                // æ¸…é™¤æ‰€æœ‰åœ–è¡¨
                allCharts.forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        try {
                            chart.destroy();
                        } catch (e) {}
                    }
                });
                allCharts = [];
                return;
            }

            isLoading = true;
            
            // å…ˆæ¸…é™¤æ‰€æœ‰èˆŠçš„åœ–è¡¨
            allCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    try {
                        chart.destroy();
                    } catch (e) {}
                }
            });
            allCharts = [];

            document.getElementById('detailSection').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('chartWrapper').classList.add('hidden');
            document.getElementById('noData').classList.add('hidden');

            try {
                let countryData;
                
                if (dataCache[country]) {
                    countryData = dataCache[country];
                } else {
                    const response = await fetch(`statcounter_data/${country}_data.json`);
                    if (!response.ok) {
                        throw new Error('æ•¸æ“šæ–‡ä»¶ä¸å­˜åœ¨');
                    }
                    countryData = await response.json();
                    dataCache[country] = countryData;
                }

                // æ ¹æ“šå¯¦éš›æ•¸æ“šå‹•æ…‹æ›´æ–°å¹³å°é¸é …ï¼ˆç§»é™¤æ²’æœ‰æ•¸æ“šçš„å¹³å°ï¼‰
                updatePlatformOptions(countryData, dataType);
                
                console.log('è¼‰å…¥æ•¸æ“š:', { 
                    country, 
                    dataType, 
                    platform, 
                    availableDataTypes: Object.keys(countryData.data || {}) 
                });
                
                if (dataType === 'all') {
                    displayAllDataTypes(countryData, platform);
                } else {
                    displayChart(countryData, dataType, platform);
                }
                
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('noData').classList.remove('hidden');
            } finally {
                isLoading = false;
            }
        }

        // é¡¯ç¤ºæ‰€æœ‰æ•¸æ“šé¡å‹ï¼ˆç”¨åœ–è¡¨é¡¯ç¤ºï¼Œå¡ç‰‡å·¦å³æ’åˆ—ï¼‰
        function displayAllDataTypes(countryData, platform) {
            // å…ˆæ¸…é™¤æ‰€æœ‰èˆŠçš„åœ–è¡¨å¯¦ä¾‹
            allCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    try {
                        chart.destroy();
                    } catch (e) {
                        console.error('éŠ·æ¯€åœ–è¡¨æ™‚å‡ºéŒ¯:', e);
                    }
                }
            });
            allCharts = [];
            
            const container = document.getElementById('chartWrapper');
            // å®Œå…¨æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('noData').classList.add('hidden');
            
            const allData = [];
            
            Object.keys(countryData.data).forEach(dataType => {
                const dataInfo = countryData.data[dataType];
                if (dataInfo) {
                    let platformData = null;
                    
                    if (platform === 'all') {
                        // å„ªå…ˆä½¿ç”¨allå¹³å°ï¼Œå¦å‰‡ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„å¹³å°
                        platformData = dataInfo.all || dataInfo.mobile || dataInfo.desktop || dataInfo.tablet;
                    } else {
                        platformData = dataInfo[platform];
                    }
                    
                    if (platformData && platformData.data && platformData.data.length > 0) {
                        let url = platformData.url;
                        // ä¿®æ­£ vendor_mobile çš„ URL
                        if (dataType === 'vendor_mobile') {
                            const countryCode = countryData.country_code || 'global';
                            url = fixVendorUrl(url, countryCode, platform);
                        }
                        allData.push({
                            type: dataType,
                            typeName: typeNames[dataType] || dataType,
                            data: platformData.data,
                            url: url
                        });
                    }
                }
            });
            
            if (allData.length === 0) {
                document.getElementById('noData').classList.remove('hidden');
                return;
            }
            
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('chartTitle').textContent = 
                `${countryData.country_name} - æ‰€æœ‰æ•¸æ“šé¡å‹ (${platformNames[platform] || platform})`;
            
            // å»ºç«‹ grid å®¹å™¨ï¼Œè®“å¤šå€‹åœ–è¡¨å¡ç‰‡å·¦å³æ’åˆ—
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            container.appendChild(grid);

            // ç‚ºæ¯å€‹æ•¸æ“šé¡å‹å‰µå»ºåœ–è¡¨å¡ç‰‡
            allData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg p-4 shadow-md border border-gray-200';

                // ä½¿ç”¨å”¯ä¸€çš„ID
                const canvasId = `chart_all_${index}_${Math.random().toString(36).substr(2, 9)}`;
                const canvas = document.createElement('canvas');
                canvas.id = canvasId;
                canvas.style.height = '200px';
                canvas.style.width = '100%';
                
                card.innerHTML = `
                    <h4 class="text-lg font-bold mb-3">${item.typeName}</h4>
                `;
                
                // å‰µå»ºåœ–è¡¨å®¹å™¨ï¼Œå›ºå®šé«˜åº¦
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.style.height = '200px';
                chartContainer.style.position = 'relative';
                chartContainer.style.width = '100%';
                chartContainer.style.marginBottom = '1rem';
                chartContainer.appendChild(canvas);
                card.appendChild(chartContainer);
                
                // æ•¸æ“šåˆ—è¡¨
                const dataList = document.createElement('div');
                dataList.className = 'mt-4 space-y-2';
                item.data.forEach(d => {
                    const dataItem = document.createElement('div');
                    dataItem.className = 'flex justify-between items-center p-2 rounded hover:bg-gray-100 data-item cursor-pointer transition-colors';
                    if (item.url) {
                        dataItem.onclick = () => window.open(item.url, '_blank');
                        dataItem.title = 'é»æ“ŠæŸ¥çœ‹æ•¸æ“šä¾†æº';
                    }
                    dataItem.innerHTML = `
                        <span>${d.name}</span>
                        <span class="font-bold text-blue-600">${d.value.toFixed(2)}%</span>
                    `;
                    dataList.appendChild(dataItem);
                });
                card.appendChild(dataList);
                
                // ä¾†æºéˆæ¥
                if (item.url) {
                    const sourceLink = document.createElement('div');
                    sourceLink.className = 'mt-3 text-sm text-gray-600';
                    sourceLink.innerHTML = `
                        <span>æ•¸æ“šä¾†æºï¼š</span>
                        <a href="${item.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                            ${item.url}
                        </a>
                    `;
                    card.appendChild(sourceLink);
                }
                
                grid.appendChild(card);
                
                // å‰µå»ºåœ–è¡¨ - ä½¿ç”¨requestAnimationFrameç¢ºä¿DOMå·²æ›´æ–°
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        try {
                            const canvasElement = document.getElementById(canvasId);
                            if (!canvasElement) {
                                console.error('æ‰¾ä¸åˆ°canvaså…ƒç´ :', canvasId);
                                return;
                            }
                            
                            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åœ–è¡¨å¯¦ä¾‹
                            if (canvasElement.chart) {
                                try {
                                    canvasElement.chart.destroy();
                                } catch (e) {
                                    console.error('éŠ·æ¯€èˆŠåœ–è¡¨æ™‚å‡ºéŒ¯:', e);
                                }
                            }
                            
                            const chartCtx = canvasElement.getContext('2d');
                            if (!chartCtx) {
                                console.error('ç„¡æ³•ç²å–canvas context');
                                return;
                            }
                            
                            const labels = item.data.map(d => d.name);
                            const values = item.data.map(d => d.value);
                            
                            let chartType = 'bar';
                            if (item.type === 'platform' || item.type === 'os_all') {
                                chartType = 'doughnut';
                            }
                            
                            const chart = new Chart(chartCtx, {
                                type: chartType,
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'å¸‚å ´ä½”æœ‰ç‡ (%)',
                                        data: values,
                                        backgroundColor: [
                                            '#06B6D4', '#6366F1', '#EC4899', '#F59E0B',
                                            '#10B981', '#F97316', '#8B5CF6', '#EF4444',
                                            '#14B8A6', '#3B82F6'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: {
                                        duration: 0 // ç¦ç”¨å‹•ç•«ï¼Œé¿å…é‡è¤‡æ¸²æŸ“
                                    },
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: { 
                                                color: '#9CA3AF', 
                                                padding: 8,
                                                font: { size: 10 }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return context.label + ': ' + context.parsed + '%';
                                                }
                                            },
                                            padding: 6,
                                            titleFont: { size: 11 },
                                            bodyFont: { size: 10 }
                                        }
                                    },
                                    scales: chartType === 'bar' ? {
                                        x: { 
                                            ticks: { 
                                                color: '#9CA3AF',
                                                font: { size: 9 }
                                            }, 
                                            grid: { color: '#374151' } 
                                        },
                                        y: { 
                                            ticks: { 
                                                color: '#9CA3AF',
                                                font: { size: 9 },
                                                callback: function(value) { return value + '%'; }
                                            },
                                            grid: { color: '#374151' }
                                        }
                                    } : {}
                                }
                            });
                            
                            // å°‡åœ–è¡¨å¯¦ä¾‹ä¿å­˜åˆ°canvaså…ƒç´ ä¸Š
                            canvasElement.chart = chart;
                            allCharts.push(chart);
                        } catch (error) {
                            console.error('å‰µå»ºåœ–è¡¨æ™‚å‡ºéŒ¯:', error, item);
                        }
                    }, index * 150);
                });
            });
        }

        // é¡¯ç¤ºåœ–è¡¨ï¼ˆå–®ä¸€æ•¸æ“šé¡å‹ï¼‰
        function displayChart(countryData, dataType, platform) {
            console.log('displayChart called:', { dataType, platform, countryDataKeys: Object.keys(countryData.data || {}) });
            
            const dataInfo = countryData.data[dataType];
            if (!dataInfo) {
                console.error('æ‰¾ä¸åˆ°æ•¸æ“šé¡å‹:', dataType, 'å¯ç”¨çš„é¡å‹:', Object.keys(countryData.data || {}));
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('noData').classList.remove('hidden');
                return;
            }
            
            console.log('æ‰¾åˆ°æ•¸æ“š:', dataInfo, 'å¹³å°:', platform);
            
            // æ ¹æ“šå¹³å°é¸æ“‡æ•¸æ“š
            let platformData = null;
            if (platform === 'all') {
                platformData = dataInfo.all || dataInfo.mobile || dataInfo.desktop || dataInfo.tablet;
            } else {
                platformData = dataInfo[platform];
            }
            
            // æ”¯æŒèˆŠæ ¼å¼
            if (!platformData && dataInfo.data) {
                platformData = dataInfo;
            }
            
            if (!platformData || !platformData.data || platformData.data.length === 0) {
                console.error('æ‰¾ä¸åˆ°å¹³å°æ•¸æ“š:', { platform, platformData, dataInfo });
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('noData').classList.remove('hidden');
                return;
            }
            
            console.log('æˆåŠŸç²å–æ•¸æ“š:', platformData);

            const chartData = platformData.data;
            const labels = chartData.map(item => item.name);
            const values = chartData.map(item => item.value);

            document.getElementById('chartTitle').textContent = 
                `${countryData.country_name} - ${typeNames[dataType] || dataType} (${platformNames[platform] || platform})`;

            // å…ˆæ¸…é™¤å®¹å™¨ï¼Œç¢ºä¿åªé¡¯ç¤ºç•¶å‰é¸æ“‡çš„æ•¸æ“šé¡å‹
            const container = document.getElementById('chartWrapper');
            container.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰å…§å®¹
            
            // é‡æ–°å‰µå»ºåœ–è¡¨å®¹å™¨
            const chartContainer = document.createElement('div');
            chartContainer.className = 'detail-chart-container';
            const canvas = document.createElement('canvas');
            canvas.id = 'dataChart';
            chartContainer.appendChild(canvas);
            container.appendChild(chartContainer);
            
            // é¡¯ç¤ºåœ–è¡¨å’Œè¡¨æ ¼
            document.getElementById('loading').classList.add('hidden');
            container.classList.remove('hidden');
            document.getElementById('noData').classList.add('hidden');

            // æ¸…é™¤æ‰€æœ‰åœ–è¡¨å¯¦ä¾‹
            if (currentChart) {
                try {
                    currentChart.destroy();
                } catch (e) {
                    console.error('éŠ·æ¯€åœ–è¡¨æ™‚å‡ºéŒ¯:', e);
                }
            }
            allCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    try {
                        chart.destroy();
                    } catch (e) {
                        console.error('éŠ·æ¯€åœ–è¡¨æ™‚å‡ºéŒ¯:', e);
                    }
                }
            });
            allCharts = [];
            currentChart = null;

            // ç­‰å¾…DOMæ›´æ–°å¾Œå†å‰µå»ºåœ–è¡¨
            setTimeout(() => {
                const ctx = document.getElementById('dataChart').getContext('2d');
                let chartType = 'bar';
                if (dataType === 'platform' || dataType === 'os_all') {
                    chartType = 'doughnut';
                }

                currentChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å¸‚å ´ä½”æœ‰ç‡ (%)',
                            data: values,
                            backgroundColor: [
                                '#06B6D4', '#6366F1', '#EC4899', '#F59E0B',
                                '#10B981', '#F97316', '#8B5CF6', '#EF4444',
                                '#14B8A6', '#3B82F6'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: '#9CA3AF', 
                                    padding: 10,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                },
                                padding: 8,
                                titleFont: { size: 12 },
                                bodyFont: { size: 11 }
                            }
                        },
                        scales: chartType === 'bar' ? {
                            x: { 
                                ticks: { 
                                    color: '#9CA3AF',
                                    font: { size: 10 }
                                }, 
                                grid: { color: '#374151' } 
                            },
                            y: { 
                                ticks: { 
                                    color: '#9CA3AF',
                                    font: { size: 10 },
                                    callback: function(value) { return value + '%'; }
                                },
                                grid: { color: '#374151' }
                            }
                        } : {}
                    }
                });
                
                allCharts.push(currentChart);
                
                // æ›´æ–°è¡¨æ ¼
                updateTable(chartData, platformData.url, platform);
                
                // ç¢ºä¿æ•¸æ“šä¾†æºé¡¯ç¤ºåœ¨åœ–è¡¨ä¸‹æ–¹
                const chartWrapper = document.getElementById('chartWrapper');
                const existingSource = chartWrapper.querySelector('.chart-source-link');
                if (existingSource) {
                    existingSource.remove();
                }
                
                if (platformData.url) {
                    let url = platformData.url;
                    // ä¿®æ­£ vendor_mobile çš„ URL
                    if (dataType === 'vendor_mobile') {
                        const countryCode = countryData.country_code || 'global';
                        url = fixVendorUrl(url, countryCode, platform);
                    }
                    const sourceDiv = document.createElement('div');
                    sourceDiv.className = 'mt-4 text-sm text-gray-600 chart-source-link';
                    sourceDiv.innerHTML = `
                        <span>æ•¸æ“šä¾†æºï¼š</span>
                        <a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                            ${url}
                        </a>
                    `;
                    chartWrapper.appendChild(sourceDiv);
                }
            }, 100);
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable(data, url, platform) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-gray-50' : '';
                row.innerHTML = `
                    <td class="py-2 px-4 text-gray-800">${item.name}</td>
                    <td class="py-2 px-4 font-bold text-gray-800">${item.value.toFixed(2)}%</td>
                    <td class="py-2 px-4 text-gray-800">${platformNames[platform] || platform}</td>
                    <td class="py-2 px-4">
                        ${url ? `<a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">æŸ¥çœ‹ä¾†æº</a>` : '<span class="text-gray-400">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // äº‹ä»¶ç›£è½ - å°ç£åœ‹å®¶é¸æ“‡å™¨
        document.getElementById('twCountrySelect').addEventListener('change', function() {
            loadTwCountryData();
        });

        // äº‹ä»¶ç›£è½ - å…¶ä»–åœ‹å®¶/åœ°å€æ•¸æ“š
        document.getElementById('countrySelect').addEventListener('change', function() {
            if (this.value) {
                loadCountryData();
            } else {
                document.getElementById('detailSection').classList.add('hidden');
            }
        });
        
        document.getElementById('dataTypeSelect').addEventListener('change', function() {
            const country = document.getElementById('countrySelect').value;
            if (country) {
                loadCountryData();
            }
        });
        
        document.getElementById('platformSelect').addEventListener('change', function() {
            const country = document.getElementById('countrySelect').value;
            if (country) {
                loadCountryData();
            }
        });

        // åˆå§‹åŒ–
        window.onload = () => {
            loadAllData();
            // æ¯5ç§’è‡ªå‹•åˆ·æ–°ï¼ˆæª¢æŸ¥æ–°æ•¸æ“šï¼‰
            setInterval(() => {
                if (!document.getElementById('countrySelect').value) {
                    loadAllData();
                }
            }, 5000);
        };
    </script>
</body>

</html>
